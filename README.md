# Patroni in my холстер

Сценарий Ansible предназначен для создания отказоустойчивого кластера PostgreSQL, используя Patroni и Consul на виртуальной машине с операционной системой РЕД ОС.

Первым шагом в сценарии является установка и настройка Consul на сервере. Consul - это инструмент для обнаружения и управления сервисами в распределенных системах. Затем с помощью Ansible создается группа серверов PostgreSQL, на которых будет установлен Patroni - инструмент для управления и мониторинга кластеров PostgreSQL.

Далее на каждом сервере группы PostgreSQL создаются необходимые каталоги, настраиваются репозитории и устанавливаются все необходимые зависимости и пакеты для работы PostgreSQL. Затем на каждом сервере устанавливается PostgreSQL, и запускается его настройка с помощью Patroni.

После того, как настройка PostgreSQL завершена, на серверах запускается Patroni, который занимается управлением и мониторингом кластера. Patroni обеспечивает автоматический перенос роли мастера в случае отказа текущего мастера и выбор нового мастера.


## Главный файл:

Первая пьеса устанавливает Consul на серверы, принадлежащие группе "sirius_consul". Consul - это сетка сервисов и инструмент обнаружения сервисов, который может помочь в управлении распределенными системами. Параметр "become" имеет значение "yes", чтобы указать, что программа должна выполняться с повышенными привилегиями (т.е. от имени пользователя с административным доступом).

Вторая пьеса нацелена на серверы в группе "sirius_postgres" и выполняет несколько задач. Во-первых, она создает группу томов (VG) и менеджер логических томов (LVM), которые можно использовать для управления хранением данных на серверах. Затем он устанавливает программное обеспечение базы данных PostgreSQL и инструмент vip-manager, который используется для управления виртуальными IP-адресами. Параметр "roles" указывает, что к серверам в этой пьесе должны быть применены несколько ролей Ansible, включая роли "disks", "postgres" и "vip-manager".

## Consule task 
Вот, значит, смотрю на этот код, который нашим серверам делает хорошо и бодро крутится. Ну, вижу я, что тут вначале проверяется, есть ли у нас уже пакеты для работы с SELinux, а если нет - то ставятся.

А потом идёт проверка, есть ли уже бинарник consul на сервере, и если нет - то скачивается и устанавливается. И сразу создаётся папка для логов, ибо без неё мы будем как без головы.

Ну а дальше у нас уже интереснее. Проверяется, сколько у нас серверов с consul'ом, и по их IP-адресам определяется название датацентра, если оно ещё не задано. Если все сервера находятся в одном датацентре - то берётся его название, если нет - то пишется какое-то резервное название.

А потом идут какие-то задачи по шифрованию ключей, я так понимаю, это для безопасности данных. И в конце - копирование конфигурационных файлов для consul'а на серверы, с последующей перезагрузкой сервиса, чтобы новые настройки вступили в силу.

## Disks task 
Пришло время создать некоторые диски для хранения данных. Нам нужно создать том группы на основе дисков /dev/sdb и /dev/sdc и назвать его "pg". Потом создадим логические разделы "pg_data" и "pg_val" на этом томе. "pg_data" будет использовать /dev/sdb, а "pg_val" - /dev/sdc. После этого, нам нужно создать файловую систему ext4 на обоих разделах.

## Итог:
Данный сценарий автоматизирует установку и настройку отказоустойчивого кластера PostgreSQL с помощью Patroni и Consul на серверах с операционной системой РЕД ОС, что позволяет обеспечить высокую доступность и надежность работы базы данных. 
